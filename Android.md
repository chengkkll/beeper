# 安卓端需求


- [安卓端需求](#安卓端需求)
  - [修改程序配置](#修改程序配置)
    - [操作流程](#操作流程)
    - [程序启动流程](#程序启动流程)
  - [调用科大讯飞的语音模块](#调用科大讯飞的语音模块)
  - [显示设备侧边的灯](#显示设备侧边的灯)
  - [检查服务端命令](#检查服务端命令)
  - [日志处理](#日志处理)
  - [读卡器](#读卡器)
  - [Bug修复](#bug修复)

## 修改程序配置

> 进入方式为屏幕左上角连点10次
> 
> 需要配置的信息有3个：服务器IP、诊区编号、设备编号。
>
> 页面有2个按钮：测试连接 与 保存。
> 
> “测试连接”按钮，用来检查是否能连接上指定的服务器。（该功能通过一个测试接口来实现）
>
> “保存”按钮，保存3个配置，并根据配置（诊区编号、设备编号）调用服务器接口获取完整配置存储在Android。
> 

### 操作流程
1. 进入配置页。
   
    可以连续点击右上角进入。

    如果服务器连接失败，进入配置页面。

2. 显示配置页面。
   
    配置页面中会显示当前Android设备的Id、本机IP。

    配置页面中需要配置：服务器IP、诊区编号、设备编号。

3. 保存配置后，调用接口获取完整配置Json
   
    调用接口参数：设备Id、本机IP、诊区编号、设备编号、

    完整配置包括：是否语音播报、播报轮询间隔、音调、语速、音量、登录首页模板、是否控制侧灯、侧灯状态轮询间隔、是否调用读卡器、读卡器调用间隔。

4. 屏幕显示加载到的配置信息。并等待2秒钟

    显示信息包括：服务器地址、设备Id、本机IP、诊区编号、设备编号、是否语音播报、是否控制侧灯、是否调用读卡器、计算后的登录首页地址

5. 根据登录首页地址加载页面

> 由于使用场景不同，诊区编号、设备编号的名称不适合某些业务场景。显示时需要换个显示的名称，只改显示名称，其他不变。
> 
> 例如：诊区编号，有时候需要显示为网点编号。
> 
> 方案一
> 
> 调用服务器接口获取服务器IP、诊区编号、设备编号的显示名称。
> 
> 如果调用失败，默认使用服务器IP、诊区编号、设备编号这3个名称。
> 
> 方案二
> 
> 可以考虑将配置的3个属性（服务器IP、诊区编号、设备编号）名称存到Android设备的某个位置，读取显示。
>
> 方案三
> 
> 或者不同的配置名称，打包成不同的安装程序？
>

### 程序启动流程

为上一个流程的3、4、5

## 调用科大讯飞的语音模块

> 使用科大讯飞的离线包语音模块
>
> 科大讯飞地址：https://www.xfyun.cn/service/offline_tts
>
> 后期计划使用4944的基础包。

## 显示设备侧边的灯

> 如果配置中需要控制侧灯，则按轮询时间定时获取灯的状态，并根据返回值，让灯做对应的显示。

## 检查服务端命令

> 通过接口定时（1分钟一次）检查服务端的命令。
> 
> 接口无命令时返回空值。

命令内容：

| 命令编码   | 命令参数示例                                                         | 命令说明                                          |
| :--------- | :------------------------------------------------------------------- | :------------------------------------------------ |
| led        | {leftColor:'red',leftProgress:10, rightColor:'red',rightProgress:10} | 设置LED灯的颜色                                   |
| ledoff     |                                                                      | 关闭LED灯                                         |
| restart    |                                                                      | 重新加载首页对应的地址                            |
| screenshot |                                                                      | 截图并发送到服务器端                              |
| setTime    | 2022-08-09 15:12:15                                                  | 设置安卓设备时间                                  |
| setVolume  | 60                                                                   | 设置安卓设备音量    （取值1-100）                 |
| readCard   | IdCard                                                               | 读卡，（IdCard身份证、VitalCard医保卡、RfidCard） |

> 注：LED的颜色包括：red、green、blue、green_blue(青色cyan)、red_blue(紫色purple)、red_green(黄色yellow)、all(白色white)

## 日志处理

> 设备实时将一些操作的状态已日志的形式发送到服务端。

日志的场景有：

| 场景编码      | 场景名称               | 说明                                               |
| :------------ | :--------------------- | :------------------------------------------------- |
| Start         | 设备启动               | 记录时间、设备编码、区域编码、                     |
| SettingLoad   | 进入配置页面           | 记录时间、设备编码、区域编码、当前的完整配置       |
| SettingSave   | 保存配置               | 记录时间、设备编码、区域编码、保存后获取的完整配置 |
| ShowHome      | 进入首页(包括重新加载) | 记录时间、设备编码、区域编码、访问的首页地址       |
| GetCommand    | 获取到服务器命令       | 记录时间、设备编码、区域编码、命令内容             |
| VoiceComplete | 完成播放语音           | 记录时间、设备编码、区域编码、播放内容             |

## 读卡器

> 定时访问读卡器，如果读取到数据，调用接口将数据发送到服务器端。

## Bug修复
1. 修改完配置后再进入程序时，经常进入2次才能正常使用
2. 横屏功能无效，不知道是不是该功能影响的问题1 ，该功能可以去掉。
3. 程序关闭后，还会播放语音。
4. 程序运行中，无断网(内网能ping通)但是连不上后端服务时（可能后端更新程序），会跳转到配置页（此时只能重启安卓设备才能继续运行），此时应该停留在网页显示的页面。
